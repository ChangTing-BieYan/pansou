name: åŒæ­¥ä¸Šæ¸¸

on:
  workflow_dispatch:        # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: "0 */6 * * *"   # æ¯ 6 å°æ—¶è‡ªåŠ¨è¿è¡Œä¸€æ¬¡

jobs:
  sync-upstream:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Git ç”¨æˆ·
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: æ·»åŠ ä¸Šæ¸¸ä»“åº“å¹¶æŠ“å–
        run: |
          git remote add upstream https://github.com/fish2018/pansou.git || true
          git fetch upstream main

      - name: ä¿å­˜æœ¬åœ°ä¿®æ”¹ï¼ˆå¤‡ä»½ä½ æ”¹è¿‡çš„ Go æ–‡ä»¶ä¸ go.modï¼‰
        run: |
          mkdir -p /tmp/mychanges/util/cache /tmp/mychanges/util/json
          cp util/cache/sharded_memory_cache.go /tmp/mychanges/util/cache/ || true
          cp util/cache/utils.go /tmp/mychanges/util/cache/ || true
          cp util/cache/global_buffer_manager.go /tmp/mychanges/util/cache/ || true
          cp util/json/json.go /tmp/mychanges/util/json/ || true
          cp go.mod /tmp/mychanges/ || true

      - name: æ£€æŸ¥ä¸Šæ¸¸å·®å¼‚å¹¶å°è¯•åˆå¹¶
        run: |
          git fetch upstream main
          # å¦‚æœå†…å®¹æ— å·®å¼‚åˆ™è·³è¿‡
          if git diff --quiet HEAD upstream/main; then
            echo "âœ… ä¸Šæ¸¸ä¸æœ¬åœ°ä¸€è‡´ï¼Œæ— éœ€åŒæ­¥"
          else
            echo "ğŸ”„ ä¸Šæ¸¸æœ‰æ–°æäº¤ï¼Œæ­£åœ¨åˆå¹¶ï¼ˆä¸Šæ¸¸ä¼˜å…ˆï¼‰..."
            git merge upstream/main -X theirs --no-edit || true
          fi

      - name: æ¢å¤æœ¬åœ°ä¿®æ”¹ï¼ˆè¦†ç›–è¢«ä¸Šæ¸¸æ”¹åŠ¨çš„æ–‡ä»¶ï¼‰
        run: |
          cp /tmp/mychanges/util/cache/sharded_memory_cache.go util/cache/ || true
          cp /tmp/mychanges/util/cache/utils.go util/cache/ || true
          cp /tmp/mychanges/util/cache/global_buffer_manager.go util/cache/ || true
          cp /tmp/mychanges/util/json/json.go util/json/ || true
          cp /tmp/mychanges/go.mod . || true

      - name: æäº¤å¹¶æ¨é€æ›´æ–°
        run: |
          git add .
          if git diff --cached --quiet; then
            echo "âœ… æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            git commit -m "ğŸ”„ åŒæ­¥ä¸Šæ¸¸ä»“åº“ï¼ˆä¿ç•™ ARMv7 å…¼å®¹ Go ä¿®æ”¹ä¸ go.modï¼‰"
            git push origin main
          fi
